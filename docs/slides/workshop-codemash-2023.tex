% !TeX document-id = {31322199-07d0-4e7b-ac39-8f4bff032313}
% !TeX root = workshop-codemash-2023.tex
% !TeX TXS-program:compile = txs:///pdflatex/[--shell-escape]
% !TeX encoding = UTF-8
% !TeX spellcheck = en_US
% https://orcid.org/0000-0003-4586-8500
% session details: https://www.codemash.org/session-details/?id=375030

% Other possible values are: 1610, 149, 54, 43 and 32.
% By default, it is to 128mm by 96mm(4:3)
\documentclass[aspectratio=169]{beamer}
\include{preamble}
\begin{document}

%%% Title Slide %%%
\frame{\titlepage}

% uncomment one of these for the whole doc, or add at the start of a section as desired                                                                 
%\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/field.jpg}}
%\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/landscape.jpg}}
\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/tree.jpg}}


%\section{INTRODUCTION}
\begin{frame}
	\Huge \textcolor{dgreen}{INTRODUCTION}
\end{frame}
                                                                          
\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/field.jpg}}

\begin{frame}
	\frametitle{Resources}
	\begin{columns}
		\begin{column}{0.65\textwidth}
			\begin{itemize}
				\item \href{https://www.codemash.org/session-details/?id=375030}{Click here for Session Details}
				\item Project source files are available: \url{https://github.com/devsecfranklin/workshop-codemash-2023}
				\item Prework \href{https://prereqs.codemash.org/}{available at this link}.
			\end{itemize}
		\end{column}
		\begin{column}{0.35\textwidth}
			\begin{center}
				\includegraphics[width=0.585\textwidth]{../images/qr-code.png}
			\end{center}
		\end{column}
	\end{columns}
\end{frame}

\begin{frame}
	\frametitle{Contact}
	\begin{center}
		Github: \href{https://github.com/devsecfranklin}{devsecfranklin} .xXx. 
		E-mail: \textbf{\href{mailto:devsecfranklin@duck.com}{devsecfranklin@duck.com}}
		\vspace{2mm}
		\includegraphics[width=0.785\textwidth]{../images/contact.png}
	\end{center}
\end{frame}
\note[itemize]{
	\item The picture is how I feel when I use these services.
	\item mention day job, what I do there.
}

\begin{frame}
	\frametitle{Overview: Usage}
	The big picture for operation.
	\vspace{2mm}
	\includegraphics[width=0.785\textwidth]{../images/arch_diagrams-big-block.png}
\end{frame}
\note[itemize]{
	\item Notice that a full working version of this project is running on the Github repository for the project.
	\item In the first step, you push a code change to your github repository.
	\item In step 2, a GH action triggers a call to the the cloud function in GCP.
	\item In step 3, the cloud function makes a call to the webhook in Github.
}

\begin{frame}
	\frametitle{Outline: What will we cover?}
	A high level overview of the learning path is as follows:
	\begin{raggedright}
		\begin{itemize}
			\item Prework
			\begin{itemize}
				\item Github project repository setup.
				\item Set up the development environment.
				\item Set up Google Cloud account.
			\end{itemize}
			\item In Class setup slides.
			\item Review the Python source for the bot.
			\item Configure Terraform and deploy the bot.
			\item (Optional) Deploy to one of your repositories in Github.
			\item (Time permitting) Explore possibilities for extending the functionality.
		\end{itemize}
	\end{raggedright}
	\vspace{2mm}
\end{frame}
\note[itemize]{
	\item Notice there are navigation links in the top of each slide. This is because I used a template and don't how to turn them off. Also, you're welcome.
	\item The prework links are on the codemash website, as shown in a previous slide. Should be a clickable link.
	\item it is expected that you've completed the prework before the session begins on Jan 10th. Show of hands, who finished it?
}

\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/tree.jpg}}

%\section{PRE-WORK}
\begin{frame}
	\Huge \textcolor{dgreen}{PRE-WORK}
\end{frame}
                                                                          
\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/field.jpg}}

\begin{frame}
	\frametitle{Setup: VSCode}
	VSCode (\href{https://code.visualstudio.com}{https://code.visualstudio.com})
	\begin{itemize}
		\item Windows 64 bit User Installer: \href{https://prereqs.codemash.org/Files/VVSCodeUserSetup-x64-1.73.1.exe}{VSCodeUserSetup-x64-1.73.1.exe}
		\item Mac Universal: \href{https://prereqs.codemash.org/Files/VSCode-darwin-universal.zip}{VSCode-darwin-universal.zip}
		\item Linux (Debian, Ubuntu): \href{https://prereqs.codemash.org/Files/code_1.73.1-1667967334_amd64.deb}{code\_1.73.1-1667967334\_amd64.deb}
		\item  Linux (Red Hat, Fedora, SUSE): \href{https://prereqs.codemash.org/Files/code-1.73.1-1667967421.el7.x86_64.rpm}{code-1.73.1-1667967421.el7.x86\_64.rpm}
	\end{itemize}
	\vspace{2mm}
	\href{https://code.visualstudio.com/docs/devcontainers/containers}{Click this link for details on using dev containers in VSCode}
\end{frame}
\note[itemize]{
	\item Is anyone stuck on this step?
}

\begin{frame}
	\frametitle{Setup: git}
	GIT (\href{https://git-scm.com/downloads}{https://git-scm.com/downloads})
	\begin{itemize}
		\item Windows 32 Bit: \href{https://prereqs.codemash.org/Files/Git-2.38.1-64-bit.exe}{Git-2.38.1-64-bit.exe}
		\item Windows 64 Bit: \href{https://prereqs.codemash.org/Files/Git-2.38.1-32-bit.exe}{Git-2.38.1-32-bit.exe}
		\item Mac: \href{https://prereqs.codemash.org/Files/git-2.15.0-intel-universal-mavericks.dmg}{git-2.15.0-intel-universal-mavericks.dmg}
	\end{itemize}
\end{frame}
\note[itemize]{
	\item Is anyone stuck on this step?
}

\begin{frame}
	\frametitle{Setup: Docker Desktop}
	Docker Desktop (\href{https://www.docker.com/}{https://www.docker.com/})

	\begin{itemize}
		\item Windows: \href{https://prereqs.codemash.org/Files/Docker\%20Desktop\%20Installer.exe}{Docker Desktop Installer.exe}
		\item MacOS (Intel Chip): \href{https://prereqs.codemash.org/Files/Docker.dmg}{Docker.dmg}
		\item MacOS (M1 Chip): \href{https://prereqs.codemash.org/Files/Chip/Docker.dmg}{Docker.dmg}
		\item Linux instructions can be found: \href{https://docs.docker.com/desktop/install/linux-install/}{here}
	\end{itemize}
	\vspace{2mm}

	\href{https://code.visualstudio.com/docs/devcontainers/containers\#\_installation}{Click here to see Docker setup steps from Microsoft}
\end{frame}
\note[itemize]{
	\item Is anyone stuck on this step?
}

\begin{frame}
	\frametitle{Setup: Clone and Open the Project Repository}
	\begin{itemize}
		\item Time to clone the repository.
		\item \href{https://github.com/devsecfranklin/workshop-codemash-2023}{Click this link for the Github repository}
		\item In VSCode, press F1 and enter the command ``Dev Containers: Open Folder in Container''
		      \begin{itemize}
			      \item You can also choose ``Dev Containers: Open Workspace in Container''
			      \item \href{https://code.visualstudio.com/docs/devcontainers/tutorial}{Here is the Microsoft VSCode dev containers tutorial}
		      \end{itemize}
		\item From the top menu select ``Terminal -- New Terminal''
		\item Now ``cd /workspaces/workshop-codemash-2023/bin'' and type ``setup-dev-env.sh''
	\end{itemize}
	\vspace{2mm}
\end{frame}
\note[itemize]{
	\item this is a test
}

\begin{frame}
	\frametitle{Google Cloud: Account Setup}
	\begin{itemize}
		\item \href{https://cloud.google.com/free}{Sign up for a free tier GCP account}.
		\item Navigate to \href{https://cloud.google.com/}{https://cloud.google.com/} and make sure you have a usable project to work in.
		\item \href{https://cloud.google.com/resource-manager/docs/creating-managing-projects}{Here is some infomration about creating projects in GCP}
	\end{itemize}
\end{frame}

\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/tree.jpg}}

%\section{IN CLASS SETUP}
\begin{frame}
	\Huge \textcolor{dgreen}{IN CLASS SETUP}
\end{frame}
                                                                          
\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/field.jpg}}

\begin{frame}
	\frametitle{Google Cloud: Update Project Name and Login}
	\begin{itemize}
		\item Update your project name in the file ``/workspaces/workshop-codemash-2023/.envrc''
		\item Update your project name in the file ``/workspaces/workshop-codemash-2023/src/config.ini''
		\item Type the command ``direnv allow .'' to reload the ENV variables.
		\item In the dev container, run the command ``gcloud auth login'' and follow the directions there.
		\item Verify you are connected to GCP with the command ``gcloud auth list''
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{Google Cloud: Create Service User}
	\begin{itemize}
		\item We select our root project, we click the IAM \& Admin menu, Service Accounts option, and finally, on the + Create Service Account button.
	\end{itemize}
\end{frame}
\note[itemize]{
	\item We create a service user in GCP with limited scope of permissions.
	\item Service Accounts donâ€™t have passwords, and cannot log in via browsers.
	\item we use keys to login and send commands to GCP.
}

\begin{frame}
	\frametitle{Google Cloud: Create Secret in Secrets Mgr}

	\begin{itemize}
		\item The Cloud Function is expecting us to create a secret named ``gh\_secret\_token''.
		\item Enable the Secret Manager service.
		\item Add the secret.
	\end{itemize}
	\begin{center}
		\includegraphics[width=0.585\textwidth]{../images/gcp-secret.png}
	\end{center}
\end{frame}

\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/tree.jpg}}

%\section{PYTHON}
\begin{frame}
	\Huge \textcolor{dgreen}{PYTHON}
\end{frame}
                                                                           
\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/field.jpg}}

\begin{frame}
	\frametitle{Overview: Python Functions}
	The big picture for the Python code files.
	\vspace{2mm}

	\includegraphics[width=0.785\textwidth]{../images/arch_diagrams-python-big-block.png}
\end{frame}
\note[itemize]{
	\item Note that there are three Python files.
	\item the main.py file is called via Github action.
	\item the other two files have functions to help us manage the pull request.
}

\begin{frame}
	\frametitle{The Python Application}

	\begin{itemize}
		\item The main function is essentially a Flask app that waits for an incoming JSON messages.
		\item Let's take a closer look
	\end{itemize}
	\begin{center}
		\includegraphics[width=0.585\textwidth]{../images/main-function-py.png}
	\end{center}

\end{frame}
\note[itemize]{
	\item Open the main.py file in VSCode.
}

\begin{frame}
	\frametitle{Python: Logging}
	\begin{columns}
		\begin{column}{0.5\textwidth}
			\begin{itemize}
				\item Logging is set to the ``INFO'' level.
				\item The log files show up in GCP under the cloud function.
			\end{itemize}
			\begin{center}
				\includegraphics[width=0.85\textwidth]{../images/logging.png}
			\end{center}
		\end{column}
		\begin{column}{0.5\textwidth}
			\begin{center}
				\includegraphics[width=1.2\textwidth]{../images/cloud-function-logs.png}
			\end{center}
		\end{column}
	\end{columns}
\end{frame}
\note[itemize]{
	\item show the logging at the top of each file.
}

\begin{frame}
	\frametitle{Python: config.ini}

	\begin{itemize}
		\item \href{https://docs.python.org/3/library/configparser.html\#module-configparser}{The configparser module is used} to make customization easier.
		\item The Cloud Function is expecting us to create a secret named ``gh\_secret\_token''.
	\end{itemize}
	\vspace{2mm}

	\begin{center}
		\includegraphics[width=0.685\textwidth]{../images/config.ini.png}
	\end{center}
\end{frame}
\note[itemize]{
	\item Show the configuration helper Class.
}

\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/tree.jpg}}

%\section{TERRAFORM}
\begin{frame}
	\Huge \textcolor{dgreen}{TERRAFORM}
\end{frame}
                                                              
\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/field.jpg}}

\begin{frame}
	\frametitle{Overview: Terraform aka Deployment}
	The big picture for deployment.
	\vspace{5mm}
	
	\includegraphics[width=0.785\textwidth]{../images/arch_diagrams-deployment.png}
\end{frame}
\note[itemize]{
	\item Need a diagram that shows the flow of the application deployment.
}

\begin{frame}
	\frametitle{The Terraform Installer}
	We use Terraform to automate the Cloud Function installation.
\end{frame}

\begin{frame}
	\frametitle{Deploying with Terraform}
	Let's do a Terraform deployment of the Python code to GCP Cloud Function.
\end{frame}

\begin{frame}
	\frametitle{Github: Configure Webhook}
	\begin{columns}
		\begin{column}{0.5\textwidth}
			Configure the webhook in the settings of each repo we want to add our bot to.
		\end{column}
		\begin{column}{0.5\textwidth}
			\begin{center}
				\includegraphics[width=1.0\textwidth]{../images/webhook1.png}
			\end{center}
		\end{column}
	\end{columns}
\end{frame}
\note[itemize]{
	\item Be careful not to lose your webhook secret.
}

\begin{frame}
	\frametitle{Github: Configure Webhook (cont.)}
	\begin{columns}
		\begin{column}{0.5\textwidth}
			We will do a custom response, only to this single event.
		\end{column}
		\begin{column}{0.5\textwidth}
			\begin{center}
				\includegraphics[width=1.0\textwidth]{../images/webhook2.png}
			\end{center}
		\end{column}
	\end{columns}
\end{frame}
\note[itemize]{
	\item Be sure to save the changes at the end.
	\item the little yield sign might stay red but that will not impact the functionality.
}

\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/tree.jpg}}

%\section{EXTRA}
\begin{frame}
	\Huge \textcolor{dgreen}{EXTRA}
\end{frame}
                                                                       
\usebackgroundtemplate{\includegraphics[width=\paperwidth]{../images/field.jpg}}

\begin{frame}
	\frametitle{Extra: Connect it to your GKE cluster}
	\begin{itemize}
		\item Assuming you already have a GKE cluster, add a VPC connector so the cloud function can talk to the VPC the cluster is in.
		\item There is YAML in ``yaml/cloudbot'' that can be used to add a service to an existing GKE cluster.
	\end{itemize}
\end{frame}
\note[itemize]{
	\item I can demo this or we can try it if we have time.
}

\begin{frame}
	\frametitle{Extra: GNU Autotools}
	\begin{itemize}
		\item Execute the ``bootstrap.sh'' script from the top level of the repository.
		\item That should generate the ``configure'' script and the Makefiles listed in ``configure.ac''
		\item Type ``make python'' at the top level to build all the python deps. Now you can do ``. \_build/bin/activate'' to get into Python venv.
		\item You can type ``make docs'' to build the PDF files from  LaTeX.
		\item The docker directory has separate Makefile, type ``make build'' and ``make push'' from that directory.
	\end{itemize}
	\vspace{2mm}
\end{frame}
\note[itemize]{
	\item The purpose of using Autotools is to detect Python version on different machines.
	\item Another purpose is to make sure the LaTeX env has all the tools needed.
}

\begin{frame}
	\frametitle{Extra: Dockerfile and docker-compose.yml}
	We use Docker to build the container we are working in.
\end{frame}
\note[itemize]{
	\item The docker artifacts are all contained in that directory.
}

\begin{frame}
	\frametitle{Extra: Github CI Pipeline}
	Information about what actions we are using and why.
\end{frame}

\begin{frame}
	\frametitle{Future: Scan the PR comments for commands}
	The Cloud Function could monitor the PR for certain strings, using these to trigger actions.
\end{frame}

\end{document}